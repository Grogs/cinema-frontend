<!doctype html>

<head>
  <title>London - West India Quay</title>
  <meta name="viewport" content="width=device-width, initial-scale=.5  ">
  <script src="bower_components/platform/platform.js"></script>
  <script src="bower_components/requirejs/require.js"></script>
  <script src="bower_components/finchjs/finch.js"></script>
  <script src="jquery-1.9.1.js"></script>
  <link rel="import" href="elements/film-card.html">
  <link rel="import" href="elements/film-list.html">
  <link href="bower_components/components-font-awesome/css/font-awesome.css" rel="stylesheet">
  <!-- <script src="config.js"></script> -->

  <style type="text/css">
    #films {
        text-align: center;
        margin: 8px;

    }
    body {
      background-color: #111;
      margin: 0px;
    }
    #attribution {
      color: #999;
      font-family: HelveticaNeue, Verdana, Arial, sans-serif;
      text-align: center;
    }
    #attribution > a {
      color: #bbb;
    }

    div.menu-group {
      display: inline-block;
      padding-left: 20px;
    }
    select.menu {
      padding: 8px 15px 8px 10px;
      margin: 7px 7px 7px 1px;
      border-radius: 10px;
      /* Rectangle 1: */
      background: #610404;
      border: 1px solid #7F1717;

      font-family: Calibri, Verdana, Arial, sans-serif;
      font-size: 16px;
      color: #FFFFFF;
      line-height: 20px;

      color: white;
      min-width: 190px;
      -webkit-appearance: none;
      background:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50px' height='50px'><polyline points='46.139,15.518 25.166,36.49 4.193,15.519' fill='white'/></svg>") right no-repeat;      
      background-color: #640F0F;
      background-position: right 10px top 9px;
      background-size: 18px 18px;
    }

    body {
      margin-top: 0px;
    }

    header {
      width: 100%;
      /*height: 52px;*/
      background-color: #690B0B;
      text-align: center;
    }


  </style>

  <script type="text/javascript">
  //depends on jQuery
  var DummyMovieService = {
    getMovies: function(cinemaId) {
      return $.get('example_cineworld_data.json')
    },
    getPerformances: function(cinemaId) {
      return $.get('example_cineworld_performances_data.json')
    }
  }
  var RealMovieService = {
    getMovies: function(cinemaId) {
      return $.get('/cinema-api/cinema/'+cinemaId)
    },
    getPerformances: function(cinemaId) {
      return $.get('/cinema-api/cinema/'+cinemaId+"/performances")
    }
  }
  
  var MovieService = RealMovieService


  var filmList = function() {return document.querySelector("#films-list")}


  var addToMoviesList = function(films) {
    function filmToMovie(f) {
      return {
        id: f.cineworldId,
        performances: [],
        ratings: {imdb: f.rating, rt: f.criticRating, rtAudience:f.audienceRating},
        name: f.title, 
        imdbUrl: (f.imdbId ? "http://www.imdb.com/title/tt" + f.imdbId : undefined),
        poster: f.posterUrl,
        format: f.format
      }
    } 
    filmList().movies = films.map(filmToMovie)
  }

  //16:20 => 16.2
  function ts2float(timestamp) {
    function parse(s) {return parseInt(s)}
    var hm = timestamp.split(/[.:]/).map(parse)
    return hm[0] + (hm[1]/60)
  }

  var updateMoviesWithShowtimes = function(performances) {
    function isntPast(performance) {
      var tminus20 = ts2float(new Date(Date.now() - (20 * 60 * 1000)).toTimeString().substring(0,5))
      return ts2float(performance.time) > tminus20
    }
    filmList().movies.forEach(function(movie) {  
      movie.performances = ((performances[movie.id] || []).filter(isntPast) || [])
    })
  }

  var sorts = {
    critic: function(a,b) {
      return (b.ratings.rt || 0) - (a.ratings.rt || 0)
    },
    audience: function(a,b) {
      return (b.ratings.rtAudience || 0) - (a.ratings.rtAudience || 0)
    },
    imdb: function(a,b) {
      return (b.ratings.imdb || 0) - (a.ratings.imdb || 0)
    },
    showtime: function(a,b) {
      return ts2float((a.performances[0]||{}).time || "99:0") - ts2float((b.performances[0]||{}).time || "99:0")
    }
  }
  function sortBy(item) {
      var sort = sorts[item.value]
      filmList().movies.sort( sort )
  }

  // function sortFilms() {
  //   filmList().movies.sort()
  // }
  </script>

  <script type="text/javascript">
  //Routing, requires FinchJS.
      //require.define(['Finch',''])
    $(window).load(function() {
      Finch.route("cinema/:id", function(args) {
        filmList().loading = true
        filmList().movies = []
        var updateMovies = MovieService.getMovies(args.id).then(addToMoviesList)
        MovieService.getPerformances(args.id).then(function(performances) {
          updateMovies.then(function() {
            updateMoviesWithShowtimes(performances)
            filmList().loading = false
          })
        })
      })
      Finch.listen()
    })
  </script>



</head>

<body> 
  <header>
    <div class="menu">
      <div class="menu-group">
        <i class="fa fa-calendar fa-lg" style="color:white;"></i>
        <select id="date" class="menu" <!-- onchange="sortBy(this)" -->>
          <option value="?" selected="selected" label="Today">Showing Today</option>
        </select>
      </div>
      <div class="menu-group">
        <i class="fa fa-sort-alpha-asc fa-lg" style="color:white;"></i>
        <select id="ordering" class="menu" onchange="sortBy(this)">
          <option value="?" selected="selected">Order by...</option>
          <option value="imdb">IMDb Rating (Descending)</option>
          <option value="critic">RT Critic Rating (Descending)</option>
          <option value="critic">RT Audience Rating (Descending)</option>
          <option value="showtime">Next Showing</option>
        </select>
      </div>

    </div>
  </header>

  <div id="films">
    <film-list id="films-list"></film-list>
  </div>

  <div id="attribution">
    Powered by: <a href="http://www.cineworld.co.uk/">Cineworld's API</a>, <a href="http://www.omdbapi.com/">The OMDb API</a>, <a href="http://www.themoviedb.org/">TheMovieDB</a> and <a href="http://www.rottentomatoes.com/">Rotten Tomatoes</a>
  </div>
</body>
