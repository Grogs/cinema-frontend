<!doctype html>

<head>
  <title>London - West India Quay</title>
  <script src="bower_components/platform/platform.js"></script>
  <script src="bower_components/requirejs/require.js"></script>
  <script src="bower_components/finchjs/finch.js"></script>
  <script src="jquery-1.9.1.js"></script>
  <link rel="import" href="elements/film-card.html">
  <link rel="import" href="elements/film-list.html">
  <!-- <script src="config.js"></script> -->

  <style type="text/css">
    #films {
        text-align: center;
    }
  </style>

  <script type="text/javascript">
  //depends on jQuery
  var DummyMovieService = {
    getMovies: function(cinemaId) {
      return $.get('example_cineworld_data.json')
    },
    getPerformances: function(cinemaId) {
      return $.get('example_cineworld_performances_data.json')
    }
  }
  var RealMovieService = {
    getMovies: function(cinemaId) {
      return $.get('/cinema-api/cinema/'+cinemaId)
    },
    getPerformances: function(cinemaId) {
      return $.get('/cinema-api/cinema/'+cinemaId+"/performances")
    }
  }
  
  var MovieService = DummyMovieService


  var filmList = function() {return document.querySelector("#films-list")}


  var addToMoviesList = function(films) {
    function filmToMovie(f) {
      var fakeTimes = ['Showtimes unavailable']
      return {
        id: f.cineworldId,
        times: fakeTimes,
        ratings: {imdb: '-', rt: f.criticRating},
        name: f.title, 
        imdbUrl: (f.imdbId ? "http://www.imdb.com/title/tt" + f.imdbId : undefined),
        poster: f.posterUrl,
        format: f.format
      }
    }
    filmList().movies = films.map(filmToMovie)
  }

  var updateMoviesWithShowtimes = function(performances) {
    function toShowtime(performance) {
      return performance.time
    }
    filmList().movies.forEach(function(movie) {  
      movie.times = (performances[movie.id] || []).map(toShowtime)
    })
  }

  function sortFilms() {
    filmList().movies.sort(function(a,b) {return (b.ratings.rt || 0) - (a.ratings.rt || 0)})
  }
  </script>

  <script type="text/javascript">
  //Routing, requires FinchJS.
      //require.define(['Finch',''])
    $(window).load(function() {
      Finch.route("cinema/:id", function(id) {
        var updateMovies = MovieService.getMovies(66).then(addToMoviesList)
        MovieService.getPerformances(66).then(function(performances) {
          updateMovies.then(function() {
            updateMoviesWithShowtimes(performances)
          })
        })
      })
      Finch.listen()
    })
  </script>



</head>

<body> 
  <!-- <a href="#/cinema/66">Click me!</a> -->
  <a href="javascript:sortFilms()">Sort by RT rating</a>
  <div id="films">
    <film-list id="films-list"></film-list>
  </div>
</body>